name: Yie Ar Kung-Fu CI/CD

on:
  push:
    branches: [main, claude/*]
  pull_request:
    branches: [main]

env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: YieArKungFu

jobs:
  # Validate project loads without parse errors
  validate:
    name: Validate Godot Project
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Validate Scripts (Check for Parse Errors)
        run: |
          echo "Validating BaseCharacter.gd..."
          godot --headless --check-only --path . scripts/BaseCharacter.gd || exit 1
          echo "Validating Player.gd..."
          godot --headless --check-only --path . scripts/Player.gd || exit 1
          echo "✓ All scripts validated successfully!"

      - name: Import Assets
        run: |
          godot --headless --verbose --editor --quit

      - name: Load Main Scene (Smoke Test)
        run: |
          echo "Attempting to load main scene..."
          godot --headless --path . --quit || exit 1
          echo "✓ Main scene loaded successfully!"

  # Export game for multiple platforms (Phase 1: Web only for now)
  export-web:
    name: Export for Web
    runs-on: ubuntu-latest
    needs: validate
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Import Assets
        run: |
          godot --headless --verbose --editor --quit

      - name: Create Export Presets
        run: |
          cat > export_presets.cfg << 'EOF'
          [preset.0]

          name="Web"
          platform="Web"
          runnable=true
          dedicated_server=false
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="./build/web/index.html"
          encryption_include_filters=""
          encryption_exclude_filters=""
          encrypt_pck=false
          encrypt_directory=false

          [preset.0.options]

          custom_template/debug=""
          custom_template/release=""
          variant/extensions_support=false
          vram_texture_compression/for_desktop=true
          vram_texture_compression/for_mobile=false
          html/export_icon=true
          html/custom_html_shell=""
          html/head_include=""
          html/canvas_resize_policy=2
          html/focus_canvas_on_start=true
          html/experimental_virtual_keyboard=false
          progressive_web_app/enabled=false
          progressive_web_app/offline_page=""
          progressive_web_app/display=1
          progressive_web_app/orientation=0
          progressive_web_app/icon_144x144=""
          progressive_web_app/icon_180x180=""
          progressive_web_app/icon_512x512=""
          progressive_web_app/background_color=Color(0, 0, 0, 1)
          EOF

      - name: Export for Web
        run: |
          mkdir -v -p build/web
          godot --headless --verbose --export-release "Web" ./build/web/index.html

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

  # Future: Automated testing with gdUnit4 (Phase 2+)
  # Uncomment when tests are added
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: MikeSchulze/gdUnit4-action@v1
  #       with:
  #         godot-version: '4.3'
  #         paths: |
  #           res://test
  #         timeout: 5
  #         retries: 3

  # Summary job - reports overall status
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [validate, export-web]
    if: always()
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.validate.result }}" == "success" && "${{ needs.export-web.result }}" == "success" ]]; then
            echo "✓ All checks passed!"
            echo "✓ Scripts validated"
            echo "✓ Web build exported successfully"
            exit 0
          else
            echo "✗ CI checks failed"
            exit 1
          fi
